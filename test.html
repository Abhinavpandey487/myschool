<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated MCQ Test | MySchool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-50 min-h-screen p-6">
    <div class="max-w-2xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 id="testTitle" class="text-2xl font-black text-slate-900 italic">SUBJECT TEST</h1>
            <button onclick="history.back()" class="bg-white px-4 py-2 rounded-xl border font-bold text-slate-600 hover:bg-slate-100 transition">Exit</button>
        </div>

        <div id="loadingState" class="text-center py-20">
            <p class="text-slate-500 animate-pulse font-bold">Fetching 10 Questions from Cloud...</p>
        </div>

        <div id="testArea" class="hidden">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100">
                <div class="flex justify-between items-center mb-2">
                    <p id="qCount" class="text-indigo-600 font-bold">Question 1 of 10</p>
                    <span id="diffBadge" class="px-3 py-1 rounded-full text-xs font-black uppercase tracking-widest"></span>
                </div>
                <h2 id="displayQuestion" class="text-2xl font-bold text-slate-800 mb-8 leading-snug"></h2>
                
                <div id="optionsGrid" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>

        <div id="resultArea" class="hidden text-center bg-white p-12 rounded-[2.5rem] shadow-2xl border border-slate-100">
            <div class="text-6xl mb-6">üèÜ</div>
            <h2 class="text-3xl font-black text-slate-900 mb-2">Test Complete!</h2>
            <p id="scoreMsg" class="text-slate-500 mb-8 font-medium"></p>
            <p class="text-slate-400 uppercase font-bold text-xs tracking-widest">Final Result</p>
            <p id="finalScore" class="text-7xl font-black text-indigo-600 my-4">0/10</p>
            <button onclick="location.reload()" class="mt-8 bg-slate-900 text-white px-10 py-4 rounded-2xl font-bold hover:bg-indigo-600 transition shadow-lg">Retake Test</button>
        </div>

        <div id="noTest" class="hidden text-center py-20">
            <div class="text-6xl mb-6">üìù</div>
            <h2 class="text-2xl font-bold text-slate-800">Not Enough Questions</h2>
            <p class="text-slate-500 mt-2">The teacher needs to post 10 questions to start this automated test.</p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAu4leyXmPdesojF-1i394KAuprQTfx9L8",
            authDomain: "myschool-9ac84.firebaseapp.com",
            projectId: "myschool-9ac84",
            storageBucket: "myschool-9ac84.firebasestorage.app",
            messagingSenderId: "285739940891",
            appId: "1:285739940891:web:3ef4a5113a9824b4d90cbe",
            measurementId: "G-QDXQH775B3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const userClass = localStorage.getItem('userClass') || "Nursery";
        const selectedSub = localStorage.getItem('selectedSubject') || "Mathematics";
        document.getElementById('testTitle').innerText = `${selectedSub} TEST`;

        let questions = [];
        let currentIdx = 0;
        let score = 0;

        // FETCH DATA
        db.collection("schoolData")
            .where("cls", "==", userClass)
            .where("sub", "==", selectedSub)
            // .orderBy("createdAt", "desc") // Commented out to bypass indexing issues temporarily
            .limit(10)
            .get().then((querySnapshot) => {
                document.getElementById('loadingState').classList.add('hidden');
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.q && data.options) questions.push(data);
                });

                // LOCAL PEDAGOGICAL SORTING: 3 Easy -> 4 Moderate -> 3 Difficult
                // This ensures the 3-4-3 split works even without Firestore sorting
                const diffOrder = { "easy": 1, "moderate": 2, "difficult": 3 };
                questions.sort((a, b) => (diffOrder[a.difficulty] || 2) - (diffOrder[b.difficulty] || 2));

                if(questions.length > 0) {
                    renderQuestion();
                } else {
                    document.getElementById('noTest').classList.remove('hidden');
                }
            }).catch(err => {
                console.error("Cloud Error:", err);
                // Displays the specific Firebase error to help you find the index link
                document.getElementById('loadingState').innerHTML = `<p class='text-rose-500 font-bold'>Error: ${err.message}</p>`;
            });

        function renderQuestion() {
            const q = questions[currentIdx];
            document.getElementById('testArea').classList.remove('hidden');
            document.getElementById('qCount').innerText = `Question ${currentIdx + 1} of ${questions.length}`;
            document.getElementById('displayQuestion').innerText = q.q;
            
            // DIFFICULTY BADGE LOGIC
            const badge = document.getElementById('diffBadge');
            const diff = q.difficulty || "moderate";
            badge.innerText = diff;
            if(diff === 'easy') badge.className = "px-3 py-1 rounded-full text-xs font-black uppercase tracking-widest bg-emerald-100 text-emerald-600";
            else if(diff === 'difficult') badge.className = "px-3 py-1 rounded-full text-xs font-black uppercase tracking-widest bg-rose-100 text-rose-600";
            else badge.className = "px-3 py-1 rounded-full text-xs font-black uppercase tracking-widest bg-amber-100 text-amber-600";

            // SHUFFLE OPTIONS
            const shuffled = [...q.options].sort(() => Math.random() - 0.5);
            
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = shuffled.map(opt => `
                <button onclick="handleSelect('${opt.replace(/'/g, "\\'")}', '${q.a.replace(/'/g, "\\'")}')" 
                    class="w-full text-left p-6 rounded-2xl bg-slate-50 border-2 border-slate-100 hover:border-indigo-500 hover:bg-white transition-all font-bold text-slate-700">
                    ${opt}
                </button>
            `).join('');
        }

        function handleSelect(choice, correct) {
            if(choice === correct) score++;
            currentIdx++;
            if(currentIdx < questions.length) renderQuestion();
            else showResult();
        }

        function showResult() {
            document.getElementById('testArea').classList.add('hidden');
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('finalScore').innerText = `${score}/${questions.length}`;
            
            const msg = document.getElementById('scoreMsg');
            if(score === questions.length) msg.innerText = "Perfect Score! Excellent understanding of the topic. üåü";
            else if(score >= (questions.length * 0.7)) msg.innerText = "Great job! You've mastered most of the concepts. üëç";
            else msg.innerText = "Good effort! Review the video once more to improve. üìö";
        }
    </script>
</body>
</html>