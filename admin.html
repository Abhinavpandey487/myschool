<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Admin | MySchool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body class="bg-slate-900 text-white p-8">
    <div class="max-w-xl mx-auto bg-slate-800 p-8 rounded-3xl shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold italic">Post to Cloud</h1>
            <div class="flex gap-4">
                <button onclick="location.href='report.html'" class="text-indigo-400 font-bold hover:text-indigo-300 transition">View Reports</button>
                <button onclick="location.href='index.html'" class="text-rose-400 font-bold hover:text-rose-300 transition">Logout</button>
            </div>
        </div>
        
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <select id="admClass" class="w-full bg-slate-700 p-3 rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-500">
                    <option>Nursery</option>
                    <option>Class 1</option><option>Class 2</option><option>Class 3</option>
                    <option>Class 4</option><option>Class 5</option><option>Class 6</option>
                    <option>Class 7</option><option>Class 8</option>
                </select>
                <select id="admSub" class="w-full bg-slate-700 p-3 rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-500">
                    <option>Mathematics</option><option>English</option><option>Hindi</option>
                    <option>Poem</option><option>Science</option><option>SST</option>
                    <option>GK</option><option>Computer</option><option>Art</option>
                </select>
            </div>

            <input id="vId" type="text" placeholder="Paste YouTube Link for the Test" class="w-full p-3 rounded-xl bg-slate-700 outline-none focus:ring-2 focus:ring-indigo-500">
            
            <div class="border-t border-slate-700 pt-4 mt-4">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-sm text-indigo-400 font-bold">AI MCQ Generator Paste</p>
                    <span class="text-[10px] bg-slate-700 px-2 py-1 rounded">JSON Format Only</span>
                </div>
                <textarea id="bulkJson" placeholder='Paste your 10 AI questions here.
Example format:
[
  {"q": "Q1?", "options": ["A", "B", "C", "D"], "a": "A", "difficulty": "easy"},
  ...
]' class="w-full h-48 bg-slate-900/50 p-4 rounded-xl text-xs font-mono border border-slate-700 outline-none focus:border-indigo-500 transition-all"></textarea>
            </div>
            
            <button id="saveBtn" onclick="save()" class="w-full bg-indigo-600 py-4 rounded-xl font-bold hover:bg-indigo-500 active:scale-95 transition shadow-lg shadow-indigo-500/20">SAVE & POST 10 QUESTIONS</button>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const name = localStorage.getItem("teacherName");
        if (name) { document.querySelector('h1').innerText = "Welcome, " + name; }
    });

    const firebaseConfig = {
        apiKey: "AIzaSyAu4leyXmPdesojF-1i394KAuprQTfx9L8",
        authDomain: "myschool-9ac84.firebaseapp.com",
        projectId: "myschool-9ac84",
        storageBucket: "myschool-9ac84.firebasestorage.app",
        messagingSenderId: "285739940891",
        appId: "1:285739940891:web:3ef4a5113a9824b4d90cbe",
        measurementId: "G-QDXQH775B3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function save() {
        const btn = document.getElementById('saveBtn');
        const rawJson = document.getElementById('bulkJson').value.trim();
        const vUrl = document.getElementById('vId').value.trim();
        
        if (!rawJson || !vUrl) {
            alert("Please provide both the YouTube Link and the AI JSON data.");
            return;
        }

        btn.innerText = "Processing Batch..."; 
        btn.disabled = true;

        try {
            function extractID(url) {
                const reg = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(reg);
                return (match && match[2].length === 11) ? match[2] : url;
            }
            const cleanId = extractID(vUrl);

            const questions = JSON.parse(rawJson);
            if (!Array.isArray(questions)) throw new Error("Input must be a JSON Array");

            const batch = db.batch();
            const userCls = document.getElementById('admClass').value;
            const userSub = document.getElementById('admSub').value;

            questions.forEach(item => {
                const docRef = db.collection("schoolData").doc();
                batch.set(docRef, {
                    cls: userCls,
                    sub: userSub,
                    vid: cleanId,
                    q: item.q,
                    a: item.a,
                    options: item.options,
                    difficulty: item.difficulty || 'moderate',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            // Record to uploadHistory
            const historyRef = db.collection("uploadHistory").doc();
            batch.set(historyRef, {
                teacherName: localStorage.getItem("teacherName") || "Unknown Teacher",
                videoUrl: vUrl,
                videoId: cleanId,
                subject: userSub,
                className: userCls,
                questionCount: questions.length,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            await batch.commit();
            alert("âœ¨ 10 Questions and History Log posted successfully!");
            
            document.getElementById('bulkJson').value = "";
            document.getElementById('vId').value = "";

        } catch (error) {
            console.error("Upload Error:", error);
            alert("Error: " + error.message);
        } finally {
            btn.innerText = "SAVE & POST 10 QUESTIONS";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>